{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/WOWS_Test/trg-crm/app/api/resolve-maps-url/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\n\nexport async function POST(request: NextRequest) {\n    try {\n        const { url } = await request.json();\n\n        if (!url || !url.includes(\"maps.app.goo.gl\")) {\n            return NextResponse.json({ error: \"Invalid URL\" }, { status: 400 });\n        }\n\n        console.log(\"Resolving short URL:\", url);\n\n        // Fetch the short URL with redirect handling\n        const response = await fetch(url, {\n            method: \"HEAD\",\n            redirect: \"manual\", // Don't follow redirects automatically\n            headers: {\n                \"User-Agent\":\n                    \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36\",\n            },\n        });\n\n        // Get the final URL from Location header\n        const finalUrl =\n            response.headers.get(\"location\") ||\n            response.headers.get(\"Location\");\n\n        // Sau khi có finalUrl\n        if (finalUrl) {\n            // 1. Thử tìm tọa độ chính xác trong tham số !3d và !4d\n            const preciseMatch = finalUrl.match(/!3d([-.\\d]+)!4d([-.\\d]+)/);\n\n            // 2. Nếu không có, mới lấy tọa độ sau dấu @\n            const approximateMatch = finalUrl.match(/@([-.\\d]+),([-.\\d]+)/);\n\n            let lat, lng;\n\n            if (preciseMatch) {\n                lat = preciseMatch[1];\n                lng = preciseMatch[2];\n                console.log(\"Tọa độ chính xác từ Hex Params:\", lat, lng);\n            } else if (approximateMatch) {\n                lat = approximateMatch[1];\n                lng = approximateMatch[2];\n                console.log(\"Tọa độ xấp xỉ từ @:\", lat, lng);\n            }\n\n            return NextResponse.json({\n                finalUrl,\n                coordinates: lat && lng ? { lat, lng } : null,\n            });\n        } else {\n            // If HEAD doesn't work, try GET and extract from response\n            console.log(\"HEAD failed, trying GET method...\");\n            const getResponse = await fetch(url, {\n                method: \"GET\",\n                redirect: \"manual\",\n                headers: {\n                    \"User-Agent\":\n                        \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36\",\n                },\n            });\n\n            const getFinalUrl =\n                getResponse.headers.get(\"location\") ||\n                getResponse.headers.get(\"Location\");\n\n            if (getFinalUrl) {\n                console.log(\"GET redirected to:\", getFinalUrl);\n                return NextResponse.json({ finalUrl: getFinalUrl });\n            }\n\n            // If still no redirect, try to extract from response body\n            const text = await getResponse.text();\n            const urlMatch = text.match(/https:\\/\\/maps\\.google\\.com[^\"'\\s]+/);\n\n            if (urlMatch) {\n                console.log(\"Extracted URL from body:\", urlMatch[0]);\n                return NextResponse.json({ finalUrl: urlMatch[0] });\n            }\n        }\n\n        return NextResponse.json(\n            { error: \"Could not resolve URL\" },\n            { status: 400 },\n        );\n    } catch (error) {\n        console.error(\"Error resolving URL:\", error);\n        return NextResponse.json(\n            { error: \"Internal server error\" },\n            { status: 500 },\n        );\n    }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEO,eAAe,KAAK,OAAoB;IAC3C,IAAI;QACA,MAAM,EAAE,GAAG,EAAE,GAAG,MAAM,QAAQ,IAAI;QAElC,IAAI,CAAC,OAAO,CAAC,IAAI,QAAQ,CAAC,oBAAoB;YAC1C,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAc,GAAG;gBAAE,QAAQ;YAAI;QACrE;QAEA,QAAQ,GAAG,CAAC,wBAAwB;QAEpC,6CAA6C;QAC7C,MAAM,WAAW,MAAM,MAAM,KAAK;YAC9B,QAAQ;YACR,UAAU;YACV,SAAS;gBACL,cACI;YACR;QACJ;QAEA,yCAAyC;QACzC,MAAM,WACF,SAAS,OAAO,CAAC,GAAG,CAAC,eACrB,SAAS,OAAO,CAAC,GAAG,CAAC;QAEzB,sBAAsB;QACtB,IAAI,UAAU;YACV,uDAAuD;YACvD,MAAM,eAAe,SAAS,KAAK,CAAC;YAEpC,4CAA4C;YAC5C,MAAM,mBAAmB,SAAS,KAAK,CAAC;YAExC,IAAI,KAAK;YAET,IAAI,cAAc;gBACd,MAAM,YAAY,CAAC,EAAE;gBACrB,MAAM,YAAY,CAAC,EAAE;gBACrB,QAAQ,GAAG,CAAC,mCAAmC,KAAK;YACxD,OAAO,IAAI,kBAAkB;gBACzB,MAAM,gBAAgB,CAAC,EAAE;gBACzB,MAAM,gBAAgB,CAAC,EAAE;gBACzB,QAAQ,GAAG,CAAC,uBAAuB,KAAK;YAC5C;YAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACrB;gBACA,aAAa,OAAO,MAAM;oBAAE;oBAAK;gBAAI,IAAI;YAC7C;QACJ,OAAO;YACH,0DAA0D;YAC1D,QAAQ,GAAG,CAAC;YACZ,MAAM,cAAc,MAAM,MAAM,KAAK;gBACjC,QAAQ;gBACR,UAAU;gBACV,SAAS;oBACL,cACI;gBACR;YACJ;YAEA,MAAM,cACF,YAAY,OAAO,CAAC,GAAG,CAAC,eACxB,YAAY,OAAO,CAAC,GAAG,CAAC;YAE5B,IAAI,aAAa;gBACb,QAAQ,GAAG,CAAC,sBAAsB;gBAClC,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAAE,UAAU;gBAAY;YACrD;YAEA,0DAA0D;YAC1D,MAAM,OAAO,MAAM,YAAY,IAAI;YACnC,MAAM,WAAW,KAAK,KAAK,CAAC;YAE5B,IAAI,UAAU;gBACV,QAAQ,GAAG,CAAC,4BAA4B,QAAQ,CAAC,EAAE;gBACnD,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAAE,UAAU,QAAQ,CAAC,EAAE;gBAAC;YACrD;QACJ;QAEA,OAAO,gJAAY,CAAC,IAAI,CACpB;YAAE,OAAO;QAAwB,GACjC;YAAE,QAAQ;QAAI;IAEtB,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,wBAAwB;QACtC,OAAO,gJAAY,CAAC,IAAI,CACpB;YAAE,OAAO;QAAwB,GACjC;YAAE,QAAQ;QAAI;IAEtB;AACJ"}}]
}