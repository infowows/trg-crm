{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/WOWS_DEV/TruongGiang_CRM/TruongGiang_CRM_NextJS/trg-crm-webapp/lib/mongodb.ts"],"sourcesContent":["import { MongoClient } from \"mongodb\";\r\n\r\nif (!process.env.MONGODB_URI) {\r\n    throw new Error('Invalid/Missing environment variable: \"MONGODB_URI\"');\r\n}\r\n\r\nconst uri = process.env.MONGODB_URI;\r\nconsole.log(\r\n    \"üîó MongoDB URI:\",\r\n    uri.replace(/\\/\\/([^:]+):([^@]+)@/, \"//***:***@\"),\r\n); // Hide credentials\r\n\r\nconst options = {};\r\n\r\nlet client: MongoClient;\r\nlet clientPromise: Promise<MongoClient>;\r\n\r\nif (process.env.NODE_ENV === \"development\") {\r\n    // In development mode, use a global variable so that the value\r\n    // is preserved across module reloads caused by HMR (Hot Module Replacement).\r\n    let globalWithMongo = global as typeof global & {\r\n        _mongoClientPromise?: Promise<MongoClient>;\r\n    };\r\n\r\n    if (!globalWithMongo._mongoClientPromise) {\r\n        console.log(\"üîÑ Creating new MongoDB client (development)\");\r\n        client = new MongoClient(uri, options);\r\n        globalWithMongo._mongoClientPromise = client.connect();\r\n    } else {\r\n        console.log(\"‚ôªÔ∏è Reusing existing MongoDB client (development)\");\r\n    }\r\n    clientPromise = globalWithMongo._mongoClientPromise;\r\n} else {\r\n    // In production mode, it's best to not use a global variable.\r\n    console.log(\"üîÑ Creating new MongoDB client (production)\");\r\n    client = new MongoClient(uri, options);\r\n    clientPromise = client.connect();\r\n}\r\n\r\n// Add connection monitoring\r\nclientPromise\r\n    .then(() => {\r\n        console.log(\"‚úÖ MongoDB connection established\");\r\n    })\r\n    .catch((error) => {\r\n        console.error(\"‚ùå MongoDB connection failed:\", error);\r\n    });\r\n\r\nexport default clientPromise;\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,WAAW,EAAE;IAC1B,MAAM,IAAI,MAAM;AACpB;AAEA,MAAM,MAAM,QAAQ,GAAG,CAAC,WAAW;AACnC,QAAQ,GAAG,CACP,mBACA,IAAI,OAAO,CAAC,wBAAwB,gBACrC,mBAAmB;AAEtB,MAAM,UAAU,CAAC;AAEjB,IAAI;AACJ,IAAI;AAEJ,wCAA4C;IACxC,+DAA+D;IAC/D,6EAA6E;IAC7E,IAAI;IAIJ,IAAI,CAAC,gBAAgB,mBAAmB,EAAE;QACtC,QAAQ,GAAG,CAAC;QACZ,SAAS,IAAI,oKAAW,CAAC,KAAK;QAC9B,gBAAgB,mBAAmB,GAAG,OAAO,OAAO;IACxD,OAAO;QACH,QAAQ,GAAG,CAAC;IAChB;IACA,gBAAgB,gBAAgB,mBAAmB;AACvD;;AAOA,4BAA4B;AAC5B,cACK,IAAI,CAAC;IACF,QAAQ,GAAG,CAAC;AAChB,GACC,KAAK,CAAC,CAAC;IACJ,QAAQ,KAAK,CAAC,gCAAgC;AAClD;uCAEW"}},
    {"offset": {"line": 85, "column": 0}, "map": {"version":3,"sources":["file:///D:/WOWS_DEV/TruongGiang_CRM/TruongGiang_CRM_NextJS/trg-crm-webapp/models/User.ts"],"sourcesContent":["import mongoose from \"mongoose\";\r\n\r\nconst userSchema = new mongoose.Schema(\r\n    {\r\n        username: { type: String, required: true, unique: true },\r\n        password: { type: String, required: true },\r\n        email: { type: String },\r\n        fullname: { type: String },\r\n        chucVu: { type: String },\r\n        phongBan: { type: String },\r\n        avatar: { type: String },\r\n        isActive: { type: Boolean, default: true },\r\n        createdAt: { type: Date, default: Date.now },\r\n        updatedAt: { type: Date, default: Date.now },\r\n    },\r\n    { collection: \"DSNV\" },\r\n);\r\n\r\nconst User = mongoose.models.DSNV || mongoose.model(\"DSNV\", userSchema);\r\nexport default User;\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,aAAa,IAAI,mKAAQ,CAAC,MAAM,CAClC;IACI,UAAU;QAAE,MAAM;QAAQ,UAAU;QAAM,QAAQ;IAAK;IACvD,UAAU;QAAE,MAAM;QAAQ,UAAU;IAAK;IACzC,OAAO;QAAE,MAAM;IAAO;IACtB,UAAU;QAAE,MAAM;IAAO;IACzB,QAAQ;QAAE,MAAM;IAAO;IACvB,UAAU;QAAE,MAAM;IAAO;IACzB,QAAQ;QAAE,MAAM;IAAO;IACvB,UAAU;QAAE,MAAM;QAAS,SAAS;IAAK;IACzC,WAAW;QAAE,MAAM;QAAM,SAAS,KAAK,GAAG;IAAC;IAC3C,WAAW;QAAE,MAAM;QAAM,SAAS,KAAK,GAAG;IAAC;AAC/C,GACA;IAAE,YAAY;AAAO;AAGzB,MAAM,OAAO,mKAAQ,CAAC,MAAM,CAAC,IAAI,IAAI,mKAAQ,CAAC,KAAK,CAAC,QAAQ;uCAC7C"}},
    {"offset": {"line": 161, "column": 0}, "map": {"version":3,"sources":["file:///D:/WOWS_DEV/TruongGiang_CRM/TruongGiang_CRM_NextJS/trg-crm-webapp/lib/auth.ts"],"sourcesContent":["import jwt from \"jsonwebtoken\";\r\nimport bcrypt from \"bcryptjs\";\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || \"your-secret-key\";\r\n\r\nexport interface JWTPayload {\r\n    id: string;\r\n    username: string;\r\n    email: string;\r\n    ho_ten: string;\r\n    phong_ban: string;\r\n    chuc_vu: string;\r\n    phan_quyen: string;\r\n}\r\n\r\nexport function generateToken(payload: JWTPayload): string {\r\n    return jwt.sign(payload, JWT_SECRET, { expiresIn: \"7d\" });\r\n}\r\n\r\nexport function verifyToken(token: string): JWTPayload | null {\r\n    try {\r\n        return jwt.verify(token, JWT_SECRET) as JWTPayload;\r\n    } catch (error) {\r\n        return null;\r\n    }\r\n}\r\n\r\nexport async function hashPassword(password: string): Promise<string> {\r\n    return bcrypt.hash(password, 12);\r\n}\r\n\r\nexport async function comparePassword(\r\n    password: string,\r\n    hashedPassword: string,\r\n): Promise<boolean> {\r\n    return bcrypt.compare(password, hashedPassword);\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;;;AAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAYtC,SAAS,cAAc,OAAmB;IAC7C,OAAO,kJAAG,CAAC,IAAI,CAAC,SAAS,YAAY;QAAE,WAAW;IAAK;AAC3D;AAEO,SAAS,YAAY,KAAa;IACrC,IAAI;QACA,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAC7B,EAAE,OAAO,OAAO;QACZ,OAAO;IACX;AACJ;AAEO,eAAe,aAAa,QAAgB;IAC/C,OAAO,8IAAM,CAAC,IAAI,CAAC,UAAU;AACjC;AAEO,eAAe,gBAClB,QAAgB,EAChB,cAAsB;IAEtB,OAAO,8IAAM,CAAC,OAAO,CAAC,UAAU;AACpC"}},
    {"offset": {"line": 198, "column": 0}, "map": {"version":3,"sources":["file:///D:/WOWS_DEV/TruongGiang_CRM/TruongGiang_CRM_NextJS/trg-crm-webapp/app/api/auth/login/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport clientPromise from \"@/lib/mongodb\";\r\nimport User from \"@/models/User\";\r\nimport { comparePassword, generateToken } from \"@/lib/auth\";\r\nimport mongoose from \"mongoose\";\r\n\r\nexport async function POST(request: NextRequest) {\r\n    try {\r\n        console.log(\"üîê Login API called\");\r\n\r\n        const body = await request.json();\r\n        console.log(\"üìù Request body:\", {\r\n            username: body.username,\r\n            password: body.password ? \"***\" : \"missing\",\r\n        });\r\n\r\n        const { username, password } = body;\r\n\r\n        if (!username || !password) {\r\n            console.log(\"‚ùå Missing username or password\");\r\n            return NextResponse.json(\r\n                {\r\n                    success: false,\r\n                    message: \"Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p v√† m·∫≠t kh·∫©u\",\r\n                },\r\n                { status: 400 },\r\n            );\r\n        }\r\n\r\n        // Connect to MongoDB\r\n        console.log(\"üì° Connecting to MongoDB...\");\r\n        await clientPromise;\r\n        console.log(\"‚úÖ MongoDB client connected\");\r\n\r\n        await mongoose.connection.db;\r\n        console.log(\"‚úÖ MongoDB database connected\");\r\n\r\n        // Check connection\r\n        const db = mongoose.connection;\r\n        console.log(\"üìä Database name:\", db.name);\r\n        console.log(\r\n            \"üîó Connection state:\",\r\n            db.readyState === 1 ? \"connected\" : \"disconnected\",\r\n        );\r\n\r\n        // Find user by username\r\n        console.log(\"üîç Finding user:\", username);\r\n        const user = await User.findOne({ username, isActive: true });\r\n        console.log(\"üë§ User found:\", user ? \"yes\" : \"no\");\r\n\r\n        if (!user) {\r\n            console.log(\"‚ùå User not found or inactive\");\r\n            return NextResponse.json(\r\n                {\r\n                    success: false,\r\n                    message: \"T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng\",\r\n                },\r\n                { status: 401 },\r\n            );\r\n        }\r\n\r\n        console.log(\"üîë Comparing password...\");\r\n        // Compare password\r\n        const isPasswordValid = await comparePassword(password, user.password);\r\n        console.log(\"üîê Password valid:\", isPasswordValid);\r\n\r\n        if (!isPasswordValid) {\r\n            console.log(\"‚ùå Invalid password\");\r\n            return NextResponse.json(\r\n                {\r\n                    success: false,\r\n                    message: \"T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng\",\r\n                },\r\n                { status: 401 },\r\n            );\r\n        }\r\n\r\n        console.log(\"‚úÖ Authentication successful\");\r\n        // Generate JWT token\r\n        const token = generateToken({\r\n            id: user._id.toString(),\r\n            username: user.username,\r\n            email: user.email || \"\",\r\n            ho_ten: user.fullname || \"\",\r\n            phong_ban: user.phongBan || \"\",\r\n            chuc_vu: user.chucVu || \"\",\r\n            phan_quyen: \"User\",\r\n        });\r\n\r\n        console.log(\"üéüÔ∏è Token generated\");\r\n\r\n        const response = NextResponse.json({\r\n            success: true,\r\n            message: \"ƒêƒÉng nh·∫≠p th√†nh c√¥ng\",\r\n            user: {\r\n                id: user._id,\r\n                username: user.username,\r\n                email: user.email,\r\n                ho_ten: user.fullname,\r\n                phong_ban: user.phongBan,\r\n                chuc_vu: user.chucVu,\r\n                phan_quyen: \"User\",\r\n            },\r\n            token,\r\n        });\r\n\r\n        // Set HTTP-only cookie\r\n        response.cookies.set(\"token\", token, {\r\n            httpOnly: true,\r\n            secure: process.env.NODE_ENV === \"production\",\r\n            sameSite: \"lax\",\r\n            maxAge: 60 * 60 * 24 * 7, // 7 days\r\n            path: \"/\",\r\n        });\r\n\r\n        console.log(\"üç™ Cookie set\");\r\n        return response;\r\n    } catch (error) {\r\n        console.error(\"üí• Login error:\", error);\r\n        console.error(\r\n            \"üí• Error stack:\",\r\n            error instanceof Error ? error.stack : \"No stack trace\",\r\n        );\r\n        return NextResponse.json(\r\n            { success: false, message: \"C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.\" },\r\n            { status: 500 },\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAEO,eAAe,KAAK,OAAoB;IAC3C,IAAI;QACA,QAAQ,GAAG,CAAC;QAEZ,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,QAAQ,GAAG,CAAC,oBAAoB;YAC5B,UAAU,KAAK,QAAQ;YACvB,UAAU,KAAK,QAAQ,GAAG,QAAQ;QACtC;QAEA,MAAM,EAAE,QAAQ,EAAE,QAAQ,EAAE,GAAG;QAE/B,IAAI,CAAC,YAAY,CAAC,UAAU;YACxB,QAAQ,GAAG,CAAC;YACZ,OAAO,gJAAY,CAAC,IAAI,CACpB;gBACI,SAAS;gBACT,SAAS;YACb,GACA;gBAAE,QAAQ;YAAI;QAEtB;QAEA,qBAAqB;QACrB,QAAQ,GAAG,CAAC;QACZ,MAAM,2HAAa;QACnB,QAAQ,GAAG,CAAC;QAEZ,MAAM,mKAAQ,CAAC,UAAU,CAAC,EAAE;QAC5B,QAAQ,GAAG,CAAC;QAEZ,mBAAmB;QACnB,MAAM,KAAK,mKAAQ,CAAC,UAAU;QAC9B,QAAQ,GAAG,CAAC,qBAAqB,GAAG,IAAI;QACxC,QAAQ,GAAG,CACP,wBACA,GAAG,UAAU,KAAK,IAAI,cAAc;QAGxC,wBAAwB;QACxB,QAAQ,GAAG,CAAC,oBAAoB;QAChC,MAAM,OAAO,MAAM,2HAAI,CAAC,OAAO,CAAC;YAAE;YAAU,UAAU;QAAK;QAC3D,QAAQ,GAAG,CAAC,kBAAkB,OAAO,QAAQ;QAE7C,IAAI,CAAC,MAAM;YACP,QAAQ,GAAG,CAAC;YACZ,OAAO,gJAAY,CAAC,IAAI,CACpB;gBACI,SAAS;gBACT,SAAS;YACb,GACA;gBAAE,QAAQ;YAAI;QAEtB;QAEA,QAAQ,GAAG,CAAC;QACZ,mBAAmB;QACnB,MAAM,kBAAkB,MAAM,IAAA,gIAAe,EAAC,UAAU,KAAK,QAAQ;QACrE,QAAQ,GAAG,CAAC,sBAAsB;QAElC,IAAI,CAAC,iBAAiB;YAClB,QAAQ,GAAG,CAAC;YACZ,OAAO,gJAAY,CAAC,IAAI,CACpB;gBACI,SAAS;gBACT,SAAS;YACb,GACA;gBAAE,QAAQ;YAAI;QAEtB;QAEA,QAAQ,GAAG,CAAC;QACZ,qBAAqB;QACrB,MAAM,QAAQ,IAAA,8HAAa,EAAC;YACxB,IAAI,KAAK,GAAG,CAAC,QAAQ;YACrB,UAAU,KAAK,QAAQ;YACvB,OAAO,KAAK,KAAK,IAAI;YACrB,QAAQ,KAAK,QAAQ,IAAI;YACzB,WAAW,KAAK,QAAQ,IAAI;YAC5B,SAAS,KAAK,MAAM,IAAI;YACxB,YAAY;QAChB;QAEA,QAAQ,GAAG,CAAC;QAEZ,MAAM,WAAW,gJAAY,CAAC,IAAI,CAAC;YAC/B,SAAS;YACT,SAAS;YACT,MAAM;gBACF,IAAI,KAAK,GAAG;gBACZ,UAAU,KAAK,QAAQ;gBACvB,OAAO,KAAK,KAAK;gBACjB,QAAQ,KAAK,QAAQ;gBACrB,WAAW,KAAK,QAAQ;gBACxB,SAAS,KAAK,MAAM;gBACpB,YAAY;YAChB;YACA;QACJ;QAEA,uBAAuB;QACvB,SAAS,OAAO,CAAC,GAAG,CAAC,SAAS,OAAO;YACjC,UAAU;YACV,QAAQ,oDAAyB;YACjC,UAAU;YACV,QAAQ,KAAK,KAAK,KAAK;YACvB,MAAM;QACV;QAEA,QAAQ,GAAG,CAAC;QACZ,OAAO;IACX,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,mBAAmB;QACjC,QAAQ,KAAK,CACT,mBACA,iBAAiB,QAAQ,MAAM,KAAK,GAAG;QAE3C,OAAO,gJAAY,CAAC,IAAI,CACpB;YAAE,SAAS;YAAO,SAAS;QAAmC,GAC9D;YAAE,QAAQ;QAAI;IAEtB;AACJ"}}]
}